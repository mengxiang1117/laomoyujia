{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2 class="mb-4">{{ tip[1] }}</h2>
        
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">ä½œè€…: {{ tip[6] }} å‘å¸ƒäº: {{ tip[5].strftime('%Y-%m-%d %H:%M') if tip[5] else '' }}</small>
                    </div>
                    <div>
                        <button id="like-btn" class="btn btn-sm btn-outline-primary" data-tip-id="{{ tip[0] }}">
                            <span id="like-icon">ğŸ‘</span>
                            <span id="like-count">{{ tip[7] }}</span>
                        </button>
                        {% if session.user_id == tip[0] %}
                        <a href="/tips/{{ tip[0] }}/edit" class="btn btn-sm btn-outline-secondary">ç¼–è¾‘</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <h5>æ‘¸é±¼æ­¥éª¤</h5>
                <p>{{ tip[2] }}</p>
                
                <h5>æ³¨æ„äº‹é¡¹</h5>
                <p>{{ tip[3] or 'æ— ' }}</p>
                
                <h5>ç»éªŒåˆ†äº«</h5>
                <p>{{ tip[4] or 'æ— ' }}</p>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>è¯„è®º</h5>
            </div>
            <div class="card-body">
                <div id="comments">
                    {% for comment in comments %}
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>{{ comment[2] }}</strong>
                            <small class="text-muted">{{ comment[1].strftime('%Y-%m-%d %H:%M') if comment[1] else '' }}</small>
                        </div>
                        <p class="mb-0">{{ comment[0] }}</p>
                    </div>
                    {% endfor %}
                    
                    {% if not comments %}
                    <p>æš‚æ— è¯„è®º</p>
                    {% endif %}
                </div>
                
                <hr>
                
                <h5>å‘è¡¨è¯„è®º</h5>
                <form id="comment-form" data-tip-id="{{ tip[0] }}">
                    <div class="mb-3">
                        <textarea class="form-control" id="comment-content" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">æäº¤è¯„è®º</button>
                </form>
            </div>
        </div>
        
        <a href="/tips" class="btn btn-secondary">è¿”å›æŠ€å·§åˆ—è¡¨</a>
    </div>
</div>

<!-- è¯„è®ºæˆåŠŸæç¤º -->
<div class="toast-container position-fixed top-50 start-50 translate-middle" style="z-index: 9999;">
    <div id="commentSuccessToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body bg-success text-white text-center">
            è¯„è®ºæˆåŠŸ
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ç‚¹èµåŠŸèƒ½
    document.getElementById('like-btn').addEventListener('click', function() {
        const tipId = this.getAttribute('data-tip-id');
        
        fetch(`/tips/${tipId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                document.getElementById('like-count').textContent = data.like_count;
                const likeIcon = document.getElementById('like-icon');
                if(data.liked) {
                    likeIcon.textContent = 'ğŸ‘';
                } else {
                    likeIcon.textContent = 'ğŸ‘';
                }
            } else {
                alert(data.error || 'æ“ä½œå¤±è´¥');
            }
        });
    });
    
    // è¯„è®ºåŠŸèƒ½
    document.getElementById('comment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const tipId = this.getAttribute('data-tip-id');
        const content = document.getElementById('comment-content').value;
        
        const formData = new FormData();
        formData.append('content', content);
        
        fetch(`/tips/${tipId}/comment`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                // æ˜¾ç¤ºè¯„è®ºæˆåŠŸæç¤º
                var toastEl = document.getElementById('commentSuccessToast');
                var toast = new bootstrap.Toast(toastEl, {
                    delay: 500 // 0.5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                });
                toast.show();
                
                // 0.5ç§’ååˆ·æ–°é¡µé¢
                setTimeout(function() {
                    location.reload();
                }, 500);
            } else {
                alert(data.error || 'è¯„è®ºå¤±è´¥');
            }
        });
    });
});
</script>
{% endblock %}