{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4">个人中心</h2>
        
        <!-- 四个方块：个人信息、工作详情设置、摸鱼记录、加班记录 -->
        <div class="row mb-4">
            <!-- 个人信息方块 -->
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">个人信息</h5>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 250px;">
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>用户名:</strong></td>
                                <td>{{ user_info[0] }}</td>
                            </tr>
                            <tr>
                                <td><strong>性别:</strong></td>
                                <td>{{ user_info[1] or '未设置' }}</td>
                            </tr>
                            <tr>
                                <td><strong>年龄:</strong></td>
                                <td>{{ user_info[2] or '未设置' }}</td>
                            </tr>
                            <tr>
                                <td><strong>工作:</strong></td>
                                <td>{{ user_info[3] or '未设置' }}</td>
                            </tr>
                            <tr>
                                <td><strong>邮箱:</strong></td>
                                <td>{{ user_info[4] or '未设置' }}</td>
                            </tr>
                            <tr>
                                <td><strong>注册时间:</strong></td>
                                <td>{{ user_info[5].strftime('%Y-%m-%d %H:%M') if user_info[5] else '' }}</td>
                            </tr>
                        </table>
                        <a href="/profile/edit" class="btn btn-primary btn-sm">编辑信息</a>
                    </div>
                </div>
            </div>
            
            <!-- 工作详情设置方块 -->
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">工作详情设置</h5>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 250px;">
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>开始时间:</strong></td>
                                <td>{{ work_info[0].strftime('%H:%M') if work_info[0] else '未设置' }}</td>
                            </tr>
                            <tr>
                                <td><strong>结束时间:</strong></td>
                                <td>{{ work_info[1].strftime('%H:%M') if work_info[1] else '未设置' }}</td>
                            </tr>
                            <tr>
                                <td><strong>休息开始:</strong></td>
                                <td>{{ work_info[2].strftime('%H:%M') if work_info[2] else '未设置' }}</td>
                            </tr>
                            <tr>
                                <td><strong>休息结束:</strong></td>
                                <td>{{ work_info[3].strftime('%H:%M') if work_info[3] else '未设置' }}</td>
                            </tr>
                            <tr>
                                <td><strong>日薪:</strong></td>
                                <td>{{ "%.2f"|format(work_info[4]) if work_info[4] else '0.00' }} 元</td>
                            </tr>
                        </table>
                        <a href="/" class="btn btn-primary btn-sm">编辑设置</a>
                    </div>
                </div>
            </div>
            
            <!-- 摸鱼记录方块 -->
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">摸鱼记录</h5>
                    </div>
                    <div class="card-body p-0 overflow-auto" style="max-height: 250px;">
                        {% if slacking_records %}
                        <table class="table table-striped table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>项目</th>
                                    <th class="text-end">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in slacking_records %}
                                <tr>
                                    <td>{{ record[0] }}</td>
                                    <td class="text-end">
                                        <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#slackingModal" data-record-id="{{ record[3] }}">详情</a>
                                        <button class="btn btn-sm btn-outline-danger delete-slacking" data-record-id="{{ record[3] }}">删除</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="p-3 text-center text-muted">暂无记录</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 加班记录方块 -->
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">加班记录</h5>
                    </div>
                    <div class="card-body p-0 overflow-auto" style="max-height: 250px;">
                        {% if overtime_records %}
                        <table class="table table-striped table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>项目</th>
                                    <th class="text-end">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in overtime_records %}
                                <tr>
                                    <td>{{ record[0] }}</td>
                                    <td class="text-end">
                                        <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#overtimeModal" data-record-id="{{ record[3] }}">详情</a>
                                        <button class="btn btn-sm btn-outline-danger delete-overtime" data-record-id="{{ record[3] }}">删除</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="p-3 text-center text-muted">暂无记录</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 我的技巧长条显示 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">我的技巧</h5>
                <a href="/tips/new" class="btn btn-primary btn-sm">分享新技巧</a>
            </div>
            <div class="card-body p-0 overflow-auto" style="max-height: 200px;">
                {% if tips %}
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th width="40%">标题</th>
                            <th width="25%">发布时间</th>
                            <th width="20%" class="text-end">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                                                {% for tip in tips %}
                        <tr>
                            <td><a href="/tips/{{ tip[0] }}">{{ tip[2] }}</a></td>
                            <td>{{ tip[6].strftime('%Y-%m-%d %H:%M') if tip[6] else '' }}</td>
                            <td class="text-end">
                                <a href="/tips/{{ tip[0] }}/edit" class="btn btn-sm btn-outline-primary">编辑</a>
                                <button class="btn btn-sm btn-outline-danger delete-tip" data-tip-id="{{ tip[0] }}">删除</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="p-3 text-center text-muted">暂无分享的技巧</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 摸鱼记录详情模态框 -->
<div class="modal fade" id="slackingModal" tabindex="-1" aria-labelledby="slackingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="slackingModalLabel">摸鱼记录详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="slacking-record-detail">
                    <!-- 详情内容将通过 AJAX 加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 加班记录详情模态框 -->
<div class="modal fade" id="overtimeModal" tabindex="-1" aria-labelledby="overtimeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="overtimeModalLabel">加班记录详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="overtime-record-detail">
                    <!-- 详情内容将通过 AJAX 加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">确定要删除这个项目吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确定删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除成功提示 -->
<div class="toast-container position-fixed top-50 start-50 translate-middle" style="z-index: 9999;">
    <div id="deleteSuccessToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body bg-success text-white text-center">
            删除成功
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化toast
    var toastEl = document.getElementById('deleteSuccessToast');
    var toast = new bootstrap.Toast(toastEl, {
        delay: 500 // 0.5秒后自动消失
    });
    
    // 当前要删除的项目信息
    var currentDeleteInfo = {
        type: '', // 'tip', 'slacking', 'overtime'
        id: ''
    };
    
    // 删除技巧功能
    document.querySelectorAll('.delete-tip').forEach(button => {
        button.addEventListener('click', function() {
            const tipId = this.getAttribute('data-tip-id');
            currentDeleteInfo = {
                type: 'tip',
                id: tipId
            };
            document.getElementById('deleteConfirmMessage').textContent = '确定要删除这个技巧吗？';
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        });
    });
    
    // 删除摸鱼记录功能
    document.querySelectorAll('.delete-slacking').forEach(button => {
        button.addEventListener('click', function() {
            const recordId = this.getAttribute('data-record-id');
            currentDeleteInfo = {
                type: 'slacking',
                id: recordId
            };
            document.getElementById('deleteConfirmMessage').textContent = '确定要删除这个摸鱼记录吗？';
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        });
    });
    
    // 删除加班记录功能
    document.querySelectorAll('.delete-overtime').forEach(button => {
        button.addEventListener('click', function() {
            const recordId = this.getAttribute('data-record-id');
            currentDeleteInfo = {
                type: 'overtime',
                id: recordId
            };
            document.getElementById('deleteConfirmMessage').textContent = '确定要删除这个加班记录吗？';
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        });
    });
    
    // 确认删除按钮事件
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        // 关闭确认模态框
        var deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        deleteModal.hide();
        
        // 根据类型执行不同的删除操作
        if (currentDeleteInfo.type === 'tip') {
            fetch(`/tips/${currentDeleteInfo.id}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // 显示删除成功提示
                    toast.show();
                    // 0.5秒后刷新页面
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    alert(data.error || '删除失败');
                }
            });
        } else if (currentDeleteInfo.type === 'slacking') {
            fetch(`/api/slacking-record/${currentDeleteInfo.id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // 显示删除成功提示
                    toast.show();
                    // 0.5秒后刷新页面
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    alert(data.error || '删除失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败');
            });
        } else if (currentDeleteInfo.type === 'overtime') {
            fetch(`/api/overtime-record/${currentDeleteInfo.id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // 显示删除成功提示
                    toast.show();
                    // 0.5秒后刷新页面
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    alert(data.error || '删除失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败');
            });
        }
    });
    
    // 摸鱼记录详情模态框
    var slackingModal = document.getElementById('slackingModal');
    slackingModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var recordId = button.getAttribute('data-record-id');
        
        // 发送 AJAX 请求获取记录详情
        fetch(`/api/slacking-record/${recordId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 处理日期显示，避免无效日期
                    var createdAtDisplay = '未知';
                    if (data.record.created_at) {
                        try {
                            createdAtDisplay = data.record.created_at;
                        } catch (e) {
                            createdAtDisplay = data.record.created_at;
                        }
                    }
                    
                    var detailHtml = `
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>项目:</strong></td>
                                <td>${data.record.project}</td>
                            </tr>
                            <tr>
                                <td><strong>时长:</strong></td>
                                <td>${data.record.duration} 分钟</td>
                            </tr>
                            <tr>
                                <td><strong>收益:</strong></td>
                                <td>${data.record.earnings.toFixed(2)} 元</td>
                            </tr>
                            <tr>
                                <td><strong>记录时间:</strong></td>
                                <td>${createdAtDisplay}</td>
                            </tr>
                        </table>
                    `;
                    document.getElementById('slacking-record-detail').innerHTML = detailHtml;
                } else {
                    document.getElementById('slacking-record-detail').innerHTML = '<p>获取记录详情失败</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('slacking-record-detail').innerHTML = '<p>获取记录详情失败</p>';
            });
    });
    
    // 加班记录详情模态框
    var overtimeModal = document.getElementById('overtimeModal');
    overtimeModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var recordId = button.getAttribute('data-record-id');
        
        // 发送 AJAX 请求获取记录详情
        fetch(`/api/overtime-record/${recordId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 处理日期显示，避免无效日期
                    var createdAtDisplay = '未知';
                    if (data.record.created_at) {
                        try {
                            createdAtDisplay = data.record.created_at;
                        } catch (e) {
                            createdAtDisplay = data.record.created_at;
                        }
                    }
                    
                    var detailHtml = `
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>项目:</strong></td>
                                <td>${data.record.project}</td>
                            </tr>
                            <tr>
                                <td><strong>时长:</strong></td>
                                <td>${data.record.duration} 分钟</td>
                            </tr>
                            <tr>
                                <td><strong>负收益:</strong></td>
                                <td>${data.record.earnings.toFixed(2)} 元</td>
                            </tr>
                            <tr>
                                <td><strong>记录时间:</strong></td>
                                <td>${createdAtDisplay}</td>
                            </tr>
                        </table>
                    `;
                    document.getElementById('overtime-record-detail').innerHTML = detailHtml;
                } else {
                    document.getElementById('overtime-record-detail').innerHTML = '<p>获取记录详情失败</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('overtime-record-detail').innerHTML = '<p>获取记录详情失败</p>';
            });
    });
});
</script>

{% endblock %}